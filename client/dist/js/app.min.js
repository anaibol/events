/*!
 * Facebook Friend Selector
 * Copyright (c) 2013 Coders' Grave - http://codersgrave.com
 * Version: 1.2.1
 * Requires:
 *   jQuery v1.6.2 or above
 *   Facebook Integration - http://developers.facebook.com/docs/reference/javascript/
 */
;(function(window, document, $, undefined) {
  'use strict';

  var fsOptions = {},
  running = false, isShowSelectedActive = false,
  windowWidth = 0, windowHeight = 0, selected_friend_count = 1,
  search_text_base = '',

  content, wrap, overlay,
  fbDocUri = 'http://developers.facebook.com/docs/reference/javascript/',

  _start = function() {

    if ( FB === undefined ){
      alert('Facebook integration is not defined. View ' + fbDocUri);
      return false;
    }

    fsOptions = $.extend(true, {}, defaults, fsOptions);
    fsOptions.onPreStart();

    if ( fsOptions.max > 0 && fsOptions.max !== null ) {
      fsOptions.showSelectedCount = true;

      // if max. number selected, hide select all button
      fsOptions.showButtonSelectAll = false;
    }

    _dialogBox();
    fsOptions.onStart();

  },

  _close = function() {

    wrap.fadeOut(400, function(){
      content.empty();
      wrap.remove();
      _stopEvent();
      overlay.fadeOut(400, function(){
        overlay.remove();
      });
    });

    running = false;
    isShowSelectedActive = false;
    fsOptions.onClose();

  },

  _submit = function() {

    var selected_friends = [];
    $('input.fs-friends:checked').each(function(){
      selected_friends.push(parseInt($(this).val().split('-')[1], 10));
    });

    if ( fsOptions.facebookInvite === true ){
      
      var friends = selected_friends.join();

      FB.ui({
        method: 'apprequests',
        message: fsOptions.lang.facebookInviteMessage,
        to: friends
      },function(response){

        if ( response !== null ){
          fsOptions.onSubmit(selected_friends);

          if ( fsOptions.closeOnSubmit === true ) {
            _close();
          }
        }

      });
    }
    else{
      fsOptions.onSubmit(selected_friends);

      if ( fsOptions.closeOnSubmit === true ) {
        _close();
      }
    }

  },

  _dialogBox = function() {

    if (running === true) {
      return;
    }

    running = true;

    $('body').append(
      overlay = $('<div id="fs-overlay"></div>'),
      wrap = $('<div id="fs-dialog-box-wrap"></div>')
    );

    wrap.append('<div class="fs-dialog-box-bg" id="fs-dialog-box-bg-n"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-ne"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-e"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-se"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-s"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-sw"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-w"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-nw"></div>');
    wrap.append(
      content = $('<div id="fs-dialog-box-content"></div>')
    );

    var container = '<div id="fs-dialog" class="fs-color-'+fsOptions.color+'">' +
                      '<h2 id="fs-dialog-title"><span>'+fsOptions.lang.title+'</span></h2>' +

                      '<div id="fs-filter-box">' +
                        '<div id="fs-input-wrap">' +
                          '<input type="text" id="fs-input-text" title="'+fsOptions.lang.searchText+'" />' +

                          '<a href="javascript:{}" id="fs-reset">Reset</a>' +
                        '</div>' +
                      '</div>' +

                      '<div id="fs-user-list">' +
                        '<ul></ul>' +
                      '</div>' +

                      '<div id="fs-filters-buttons">' +
                        '<div id="fs-filters">' +
                          '<a href="javascript:{}" id="fs-show-selected"><span>'+fsOptions.lang.buttonShowSelected+'</span></a>' +
                        '</div>' +
      
                        '<div id="fs-dialog-buttons">' +
                          '<a href="javascript:{}" id="fs-submit-button" class="fs-button"><span>'+fsOptions.lang.buttonSubmit+'</span></a>' +
                          '<a href="javascript:{}" id="fs-cancel-button" class="fs-button"><span>'+fsOptions.lang.buttonCancel+'</span></a>' +
                        '</div>' +
                      '</div>' +
                    '</div>';


    content.html(container);
    _getFacebookFriend();
    _resize(true);
    _initEvent();
    _selectAll();

    $(window).resize(function(){
      _resize(false);
    });

  },

  _getFacebookFriend = function() {


    $('#fs-user-list').append('<div id="fs-loading"></div>');

    if ( fsOptions.addUserGroups && !fsOptions.facebookInvite ) {

      FB.api('/', 'POST', {
        batch: [
          { method: 'GET', relative_url: 'me/friends' },
          { method: 'GET', relative_url: 'me/groups' },
        ]
      }, function (response) {
        _parseFacebookFriends(response);
      });
      
    } else {
    
      FB.api('/me/friends', function(response){
        _parseFacebookFriends(response);
      }); 
    }

  },
  
  _parseFacebookFriends = function (response) {
    if ( response.error ){
      alert(fsOptions.lang.fbConnectError);
      _close();
      return false;
    }
    
    var facebook_friends = [];
    
    if ( fsOptions.addUserGroups && !fsOptions.facebookInvite ) {
      var facebook_friends = $.parseJSON(response[0].body).data;
      $.merge(facebook_friends, $.parseJSON(response[1].body).data);  
    } else {
      facebook_friends = response.data;
    }

    var max_friend_control = fsOptions.maxFriendsCount !== null && fsOptions.maxFriendsCount > 0;
    if ( fsOptions.showRandom === true || max_friend_control === true ){
      facebook_friends = _shuffleData(response.data);
    }

    for (var i = 0, k = 0; i < facebook_friends.length; i++) {
      if ( max_friend_control && fsOptions.maxFriendsCount <= k ){
        break;
      }

      if ($.inArray(parseInt(facebook_friends[i].id, 10), fsOptions.getStoredFriends) >= 0) {
        _setFacebookFriends(i, facebook_friends, true);
        k++;
      }
    }

    for (var j = 0; j < facebook_friends.length; j++) {

      if ( max_friend_control && fsOptions.maxFriendsCount <=  j + fsOptions.getStoredFriends.length){
        break;
      }

      if ($.inArray(parseInt(facebook_friends[j].id, 10), fsOptions.excludeIds) >= 0) {
        continue;
      }
      
      if ($.inArray(parseInt(facebook_friends[j].id, 10), fsOptions.getStoredFriends) <= -1) {
        _setFacebookFriends(j, facebook_friends, false);
      }

    }

    $('#fs-loading').remove();
  },

  _setFacebookFriends = function (k, v, predefined) {

    var item = $('<li/>');

    var link =  '<a class="fs-anchor" href="javascript://">' +
                  '<input class="fs-fullname" type="hidden" name="fullname[]" value="'+v[k].name.toLowerCase().replace(/\s/gi, "0")+'" />' +
                  '<input class="fs-friends" type="checkbox" name="friend[]" value="fs-'+v[k].id+'" />' +
                  '<img class="fs-thumb" src="https://graph.facebook.com/'+v[k].id+'/picture" />' +
                  '<span class="fs-name">' + _charLimit(v[k].name, 15) + '</span>' +
                '</a>';

    item.append(link);

    $('#fs-user-list ul').append(item);

    if (predefined) {
      _select(item);
    }

  },

  _initEvent = function() {
  
    wrap.delegate('#fs-cancel-button', 'click.fs', function(){
      _close();
    });
    
    wrap.delegate('#fs-submit-button', 'click.fs', function(){
      _submit();
    });
    
    
    $('#fs-dialog input').focus(function(){
      if ($(this).val() === $(this)[0].title){
        $(this).val('');
      }
    }).blur(function(){
      if ($(this).val() === ''){
        $(this).val($(this)[0].title);
      }
    }).blur();


    $('#fs-dialog input').keyup(function(){
      _find($(this));
    });


    wrap.delegate('#fs-reset', 'click.fs', function() {
      $('#fs-input-text').val('');
      _find($('#fs-dialog input'));
      $('#fs-input-text').blur();
    });


    wrap.delegate('#fs-user-list li', 'click.fs', function() {
      _select($(this));
    });
    
    $('#fs-show-selected').click(function(){
      _showSelected($(this));
    });

    $(document).keyup(function(e) {
      if (e.which === 27 && fsOptions.enableEscapeButton === true) {
        _close();
      }
    });


    if ( fsOptions.closeOverlayClick === true ) {
      overlay.css({'cursor' : 'pointer'});
      overlay.bind('click.fs', _close);
    }

  },

  _select = function(th) {
    var btn = th;

    if ( btn.hasClass('checked') ) {

      btn.removeClass('checked');
      btn.find('input.fs-friends').prop('checked', false);

      selected_friend_count--;

      if (selected_friend_count - 1 !== $('#fs-user-list li').length) {
        $('#fs-select-all').text(fsOptions.lang.buttonSelectAll);
      }

    }
    else {

      var limit_state = _limitText();
      
      if (limit_state === false) {
        btn.find('input.fs-friends').prop('checked', false);

        return false;
      }

      selected_friend_count++;

      btn.addClass('checked');
      btn.find('input.fs-friends').prop('checked', true);
    }

    _showFriendCount();
  },

  _stopEvent = function() {

    $('#fs-reset').undelegate("click.fs");
    $('#fs-user-list li').undelegate("click.fs");
    selected_friend_count = 1;
    $('#fs-select-all').undelegate("click.fs");

  },

  _charLimit = function(word, limit){

    var wlen = word.length;

    if ( wlen <= limit ) {
      return word;
    }

    return word.substr(0, limit) + '...';

  },

  _find = function(t) {

    var fs_dialog = $('#fs-dialog');
    var container = $('#fs-user-list ul');

    search_text_base = $.trim(t.val());

    if(search_text_base === ''){
      $.each(container.children(), function(){
        $(this).show();
      });

      if ( fs_dialog.has('#fs-summary-box').length ){
        if ( selected_friend_count === 1 ){
          $('#fs-summary-box').remove();
        }
        else{
          $('#fs-result-text').remove();
        }

      }
      return;
    }

    var search_text = search_text_base.toLowerCase().replace(/\s/gi, '0');

    var elements = $('#fs-user-list .fs-fullname[value*='+search_text+']');

   
    container.children().hide();
    $.each(elements, function(){
      $(this).parents('li').show();
    });

    var result_text = '';
    if ( elements.length > 0 && search_text_base > '' ){
      result_text = fsOptions.lang.summaryBoxResult.replace("{0}", '"'+t.val()+'"');
      result_text = result_text.replace("{1}", elements.length);
    }
    else{
      result_text = fsOptions.lang.summaryBoxNoResult.replace("{0}", '"'+t.val()+'"');
    }


    if ( !fs_dialog.has('#fs-summary-box').length ) {
      $('#fs-filter-box').after('<div id="fs-summary-box"><span id="fs-result-text">'+result_text+'</span></div>');
    }
    else if ( !fs_dialog.has('#fs-result-text').length ) {
      $('#fs-summary-box').prepend('<span id="fs-result-text">'+result_text+'</span>');
    }
    else {
      $('#fs-result-text').text(result_text);
    }

  },

  _resize = function( is_started ) {

    windowWidth = $(window).width();
    windowHeight = $(window).height();

    var docHeight = $(document).height(),
        wrapWidth = wrap.width(),
        wrapHeight = wrap.height(),
        wrapLeft = (windowWidth / 2) - (wrapWidth / 2),
        wrapTop = (windowHeight / 2) - (wrapHeight / 2);

    if ( is_started === true ) {
      overlay
        .css({
          'background-color' : fsOptions.overlayColor,
          'opacity' : fsOptions.overlayOpacity,
          'height' : docHeight
        })
        .fadeIn('fast', function(){
          wrap.css({
            left: wrapLeft,
            top: wrapTop
          })
          .fadeIn();
        });
    }
    else{
      wrap
        .stop()
        .animate({
          left: wrapLeft,
          top: wrapTop
        }, 200);

      overlay.css({'height': docHeight});
    }

  },

  _shuffleData = function( array_data ) {
    for (var j, x, i = array_data.length; i; j = parseInt(Math.random() * i, 10), x = array_data[--i], array_data[i] = array_data[j], array_data[j] = x);
    return array_data;
  },

  _limitText = function() {
    if ( selected_friend_count > fsOptions.max && fsOptions.max !== null ) {
      var selected_limit_text = fsOptions.lang.selectedLimitResult.replace('{0}', fsOptions.max);
      $('.fs-limit').html('<span class="fs-limit fs-full">'+selected_limit_text+'</span>');
      return false;
    }
  },

  _showFriendCount = function() {
    if ( selected_friend_count > 1 && fsOptions.showSelectedCount === true ){
    
      var selected_count_text = fsOptions.lang.selectedCountResult.replace('{0}', (selected_friend_count-1));

      if ( !$('#fs-dialog').has('#fs-summary-box').length ) {
        $('#fs-filter-box').after('<div id="fs-summary-box"><span class="fs-limit fs-count">'+selected_count_text+'</span></div>');
      }
      else if ( !$('#fs-dialog').has('.fs-limit.fs-count').length ) {
        $('#fs-summary-box').append('<span class="fs-limit fs-count">'+selected_count_text+'</span>');
      }
      else{
        $('.fs-limit').text(selected_count_text);
      }
    }
    else{

      if ( search_text_base === '' ){
        $('#fs-summary-box').remove();
      }
      else{
        $('.fs-limit').remove();
      }

    }
  },

  _resetSelection = function() {
    $('#fs-user-list li').removeClass('checked');
    $('#fs-user-list input.fs-friends').prop('checked', false);
    
    selected_friend_count = 1;
  },

  _selectAll = function() {
    if (fsOptions.showButtonSelectAll === true && fsOptions.max === null) {
      $('#fs-show-selected').before('<a href="javascript:{}" id="fs-select-all"><span>'+fsOptions.lang.buttonSelectAll+'</span></a> - ');
      
      wrap.delegate('#fs-select-all', 'click.fs', function() {
        if (selected_friend_count - 1 !== $('#fs-user-list li').length) {

          $('#fs-user-list li:hidden').show();
          _resetSelection();

          $('#fs-user-list li').each(function() {
            _select($(this));
          });
                
          $('#fs-select-all').text(fsOptions.lang.buttonDeselectAll);

          if (isShowSelectedActive === true) {
            isShowSelectedActive = false;
            $('#fs-show-selected').text(fsOptions.lang.buttonShowSelected);
          }
          
        }
        else {
          _resetSelection();
          
          _showFriendCount();
          
          $('#fs-select-all').text(fsOptions.lang.buttonSelectAll);
        }
      });
      
    }
  },

  _showSelected = function(t) {
  
    var container = $('#fs-user-list ul'),
        allElements = container.find('li'),
        selectedElements = container.find('li.checked');
    
    if (selectedElements.length !== 0 && selectedElements.length !== allElements.length || isShowSelectedActive === true) {
      if (isShowSelectedActive === true) {
        t.removeClass('active').text(fsOptions.lang.buttonShowSelected);

        container.children().show();

        isShowSelectedActive = false;
      }
      else {
        t.addClass('active').text(fsOptions.lang.buttonShowAll);

        container.children().hide();
        $.each(selectedElements, function(){
          $(this).show();
        });

        isShowSelectedActive = true;
      }
    }

  },

  defaults = {
    max: null,
    excludeIds: [],
    getStoredFriends: [],
    closeOverlayClick: true,
    enableEscapeButton: true,
    overlayOpacity: "0.3",
    overlayColor: '#000',
    closeOnSubmit: true,
    showSelectedCount: true,
    showButtonSelectAll: true,
    addUserGroups: false,
    color: "default",
    lang: {
      title: "Friend Selector",
      buttonSubmit: "Send",
      buttonCancel: "Cancel",
      buttonSelectAll: "Select All",
      buttonDeselectAll: "Deselect All",
      buttonShowSelected: "Show Selected",
      buttonShowAll: "Show All",
      summaryBoxResult: "{1} best results for {0}",
      summaryBoxNoResult: "No results for {0}",
      searchText: "Enter a friend's name",
      fbConnectError: "You must connect to Facebook to see this.",
      selectedCountResult: "You have choosen {0} people.",
      selectedLimitResult: "Limit is {0} people.",
      facebookInviteMessage: "Invite message"
    },
    maxFriendsCount: null,
    showRandom: false,
    facebookInvite: true,
    onPreStart: function(response){ return null; },
    onStart: function(response){ return null; },
    onClose: function(response){ return null; },
    onSubmit: function(response){ return null; }
  };


  $.fn.fSelector = function ( options ) {

    this.unbind("click.fs");
    this.bind("click.fs", function(){
      fsOptions = options;
      _start();
    });
    return this;

  };

})(window, document, jQuery);

angular.module('wooepa-templates', []).run(['$templateCache', function($templateCache) {
  $templateCache.put('404',
    '<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title></title><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="keywords" content="Wooepa"><meta name="description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:title"><link property="og:image" rel="image_wooepa" href="/img/logo_wooepa.png"><meta name="fragment" content="!"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><meta property="og:description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:type" content="website"><meta property="og:url" content="http://wooepa.com"><meta property="og:image" content="http://wooepa.com/img/logo_wooepa.png"><meta property="og:site_name" content="Wooepa"><meta name="msvalidate.01" content="741DD559CC819DECAF2AA49D92578598"><meta name="google-site-verification" content="w79q3QuneD2E21myOjjIUeCobYxg7Rpv_TBQsZ_Yh2M"><link rel="stylesheet" href="/css/app.min.css"><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,400italic"><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script></head><body id="{{$state.current.name.replace(\'.\', \'-\')}}"><div class="container-fluid"><header headroom tolerance="0" offset="0" scroller=".app-view" classes="{pinned:\'pinned\',unpinned:\'unpinned\',initial:\'headroom\'}"><nav role="navigation" ng-controller="HeaderCtrl" class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><i ng-show="$state.current.name != \'list\'" style="float:left;color:white;margin-top:2%;" class="fa fa-chevron-left"></i><a href="/" ui-sref="list" ng-show="$state.current.name != \'list\'" style="margin:auto;" class="navbar-brand">Back</a><a href="/" ui-sref="list" ng-show="$state.current.name === \'list\'" class="navbar-brand">Wooepa</a><button type="button" ng-init="navCollapsed = true" ng-click="navCollapsed = !navCollapsed" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><i class="fa fa-bars"></i></button><a href="/" ui-sref="in_promotion" style="margin-left:10%;" class="navbar-brand">Events in Promotion</a><a href="/" ui-sref="events" ng-show="$root.user" style="margin-left:30%;margin-right:7%;" class="navbar-brand">My Events</a><ul class="nav navbar-nav navbar-right"><li ng-if="$root.user" ng-cloak class="dropdown"><a href="#" class="dropdown-toggle"><span class="avatar pull-right"><img src="{{ $root.user.facebook.picture }}" alt="{{ $root.user.facebook.name }}" class="img-circle"></span><span class="hidden-xs hidden-sm hidden-md">{{$root.user.facebook.name}}</span><i class="fa fa-chevron-down"></i></a><ul class="dropdown-menu"><li><a ui-sref="app.page.profile" href="/me/events">My events</a></li><li class="divider"></li><li><a href="/auth/signout" target="_self" translate>Logout<i class="fa fa-sign-out"></i></a></li></ul></li><li ng-if="!$root.user" ng-cloak><a ng-href="/auth/facebook?redirectUrl={{$root.location.path() | encodeUri}}?{{$root.stateParams | encodeUri}}" translate class="login">Login</a></li></ul></div></div></nav></header><div id="menu" ng-class="{\'in\':!navCollapsed}" class="navbar-collapse collapse"><ul class="nav navbar-nav visible-xs"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a href="#"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getTime() === Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getTime() !== Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><input type="date" ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date"></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></div><div class="banner"></div><div id="wrapper"><div ui-view class="container-fluid"></div></div><script type="text/javascript" src="/js/app.min.js"></script><script src="//localhost:35729/livereload.js"></script></div></body></html>');
  $templateCache.put('500',
    '<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title></title><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="keywords" content="Wooepa"><meta name="description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:title"><link property="og:image" rel="image_wooepa" href="/img/logo_wooepa.png"><meta name="fragment" content="!"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><meta property="og:description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:type" content="website"><meta property="og:url" content="http://wooepa.com"><meta property="og:image" content="http://wooepa.com/img/logo_wooepa.png"><meta property="og:site_name" content="Wooepa"><meta name="msvalidate.01" content="741DD559CC819DECAF2AA49D92578598"><meta name="google-site-verification" content="w79q3QuneD2E21myOjjIUeCobYxg7Rpv_TBQsZ_Yh2M"><link rel="stylesheet" href="/css/app.min.css"><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,400italic"><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script></head><body id="{{$state.current.name.replace(\'.\', \'-\')}}"><div class="container-fluid"><header headroom tolerance="0" offset="0" scroller=".app-view" classes="{pinned:\'pinned\',unpinned:\'unpinned\',initial:\'headroom\'}"><nav role="navigation" ng-controller="HeaderCtrl" class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><i ng-show="$state.current.name != \'list\'" style="float:left;color:white;margin-top:2%;" class="fa fa-chevron-left"></i><a href="/" ui-sref="list" ng-show="$state.current.name != \'list\'" style="margin:auto;" class="navbar-brand">Back</a><a href="/" ui-sref="list" ng-show="$state.current.name === \'list\'" class="navbar-brand">Wooepa</a><button type="button" ng-init="navCollapsed = true" ng-click="navCollapsed = !navCollapsed" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><i class="fa fa-bars"></i></button><a href="/" ui-sref="in_promotion" style="margin-left:10%;" class="navbar-brand">Events in Promotion</a><a href="/" ui-sref="events" ng-show="$root.user" style="margin-left:30%;margin-right:7%;" class="navbar-brand">My Events</a><ul class="nav navbar-nav navbar-right"><li ng-if="$root.user" ng-cloak class="dropdown"><a href="#" class="dropdown-toggle"><span class="avatar pull-right"><img src="{{ $root.user.facebook.picture }}" alt="{{ $root.user.facebook.name }}" class="img-circle"></span><span class="hidden-xs hidden-sm hidden-md">{{$root.user.facebook.name}}</span><i class="fa fa-chevron-down"></i></a><ul class="dropdown-menu"><li><a ui-sref="app.page.profile" href="/me/events">My events</a></li><li class="divider"></li><li><a href="/auth/signout" target="_self" translate>Logout<i class="fa fa-sign-out"></i></a></li></ul></li><li ng-if="!$root.user" ng-cloak><a ng-href="/auth/facebook?redirectUrl={{$root.location.path() | encodeUri}}?{{$root.stateParams | encodeUri}}" translate class="login">Login</a></li></ul></div></div></nav></header><div id="menu" ng-class="{\'in\':!navCollapsed}" class="navbar-collapse collapse"><ul class="nav navbar-nav visible-xs"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a href="#"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getTime() === Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getTime() !== Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><input type="date" ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date"></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></div><div class="banner"></div><div id="wrapper"><div ui-view class="container-fluid"></div></div><script type="text/javascript" src="/js/app.min.js"></script><script src="//localhost:35729/livereload.js"></script></div></body></html>');
  $templateCache.put('head',
    '<head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title></title><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="keywords" content="Wooepa"><meta name="description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:title"><link property="og:image" rel="image_wooepa" href="/img/logo_wooepa.png"><meta name="fragment" content="!"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><meta property="og:description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:type" content="website"><meta property="og:url" content="http://wooepa.com"><meta property="og:image" content="http://wooepa.com/img/logo_wooepa.png"><meta property="og:site_name" content="Wooepa"><meta name="msvalidate.01" content="741DD559CC819DECAF2AA49D92578598"><meta name="google-site-verification" content="w79q3QuneD2E21myOjjIUeCobYxg7Rpv_TBQsZ_Yh2M"><link rel="stylesheet" href="/css/app.min.css"><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,400italic"><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script></head>');
  $templateCache.put('header',
    '<header headroom tolerance="0" offset="0" scroller=".app-view" classes="{pinned:\'pinned\',unpinned:\'unpinned\',initial:\'headroom\'}"><nav role="navigation" ng-controller="HeaderCtrl" class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><i ng-show="$state.current.name != \'list\'" style="float:left;color:white;margin-top:2%;" class="fa fa-chevron-left"></i><a href="/" ui-sref="list" ng-show="$state.current.name != \'list\'" style="margin:auto;" class="navbar-brand">Back</a><a href="/" ui-sref="list" ng-show="$state.current.name === \'list\'" class="navbar-brand">Wooepa</a><button type="button" ng-init="navCollapsed = true" ng-click="navCollapsed = !navCollapsed" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><i class="fa fa-bars"></i></button><a href="/" ui-sref="in_promotion" style="margin-left:10%;" class="navbar-brand">Events in Promotion</a><a href="/" ui-sref="events" ng-show="$root.user" style="margin-left:30%;margin-right:7%;" class="navbar-brand">My Events</a><ul class="nav navbar-nav navbar-right"><li ng-if="$root.user" ng-cloak class="dropdown"><a href="#" class="dropdown-toggle"><span class="avatar pull-right"><img src="{{ $root.user.facebook.picture }}" alt="{{ $root.user.facebook.name }}" class="img-circle"></span><span class="hidden-xs hidden-sm hidden-md">{{$root.user.facebook.name}}</span><i class="fa fa-chevron-down"></i></a><ul class="dropdown-menu"><li><a ui-sref="app.page.profile" href="/me/events">My events</a></li><li class="divider"></li><li><a href="/auth/signout" target="_self" translate>Logout<i class="fa fa-sign-out"></i></a></li></ul></li><li ng-if="!$root.user" ng-cloak><a ng-href="/auth/facebook?redirectUrl={{$root.location.path() | encodeUri}}?{{$root.stateParams | encodeUri}}" translate class="login">Login</a></li></ul></div></div></nav></header>');
  $templateCache.put('index',
    '<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title></title><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="keywords" content="Wooepa"><meta name="description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:title"><link property="og:image" rel="image_wooepa" href="/img/logo_wooepa.png"><meta name="fragment" content="!"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><meta property="og:description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:type" content="website"><meta property="og:url" content="http://wooepa.com"><meta property="og:image" content="http://wooepa.com/img/logo_wooepa.png"><meta property="og:site_name" content="Wooepa"><meta name="msvalidate.01" content="741DD559CC819DECAF2AA49D92578598"><meta name="google-site-verification" content="w79q3QuneD2E21myOjjIUeCobYxg7Rpv_TBQsZ_Yh2M"><link rel="stylesheet" href="/css/app.min.css"><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,400italic"><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script></head><body id="{{$state.current.name.replace(\'.\', \'-\')}}"><div class="container-fluid"><header headroom tolerance="0" offset="0" scroller=".app-view" classes="{pinned:\'pinned\',unpinned:\'unpinned\',initial:\'headroom\'}"><nav role="navigation" ng-controller="HeaderCtrl" class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><i ng-show="$state.current.name != \'list\'" style="float:left;color:white;margin-top:2%;" class="fa fa-chevron-left"></i><a href="/" ui-sref="list" ng-show="$state.current.name != \'list\'" style="margin:auto;" class="navbar-brand">Back</a><a href="/" ui-sref="list" ng-show="$state.current.name === \'list\'" class="navbar-brand">Wooepa</a><button type="button" ng-init="navCollapsed = true" ng-click="navCollapsed = !navCollapsed" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><i class="fa fa-bars"></i></button><a href="/" ui-sref="in_promotion" style="margin-left:10%;" class="navbar-brand">Events in Promotion</a><a href="/" ui-sref="events" ng-show="$root.user" style="margin-left:30%;margin-right:7%;" class="navbar-brand">My Events</a><ul class="nav navbar-nav navbar-right"><li ng-if="$root.user" ng-cloak class="dropdown"><a href="#" class="dropdown-toggle"><span class="avatar pull-right"><img src="{{ $root.user.facebook.picture }}" alt="{{ $root.user.facebook.name }}" class="img-circle"></span><span class="hidden-xs hidden-sm hidden-md">{{$root.user.facebook.name}}</span><i class="fa fa-chevron-down"></i></a><ul class="dropdown-menu"><li><a ui-sref="app.page.profile" href="/me/events">My events</a></li><li class="divider"></li><li><a href="/auth/signout" target="_self" translate>Logout<i class="fa fa-sign-out"></i></a></li></ul></li><li ng-if="!$root.user" ng-cloak><a ng-href="/auth/facebook?redirectUrl={{$root.location.path() | encodeUri}}?{{$root.stateParams | encodeUri}}" translate class="login">Login</a></li></ul></div></div></nav></header><div id="menu" ng-class="{\'in\':!navCollapsed}" class="navbar-collapse collapse"><ul class="nav navbar-nav visible-xs"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a href="#"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getTime() === Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getTime() !== Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><input type="date" ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date"></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></div><div class="banner"></div><div id="wrapper"><div ui-view class="container-fluid"></div></div><script type="text/javascript" src="/js/app.min.js"></script><script>window.user = ;\n' +
    'window.fbAppId = ;\n' +
    '//window.events = ;</script><script src="//localhost:35729/livereload.js"></script></div></body></html>');
  $templateCache.put('layout',
    '<!DOCTYPE html><html><head><base href="/"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title></title><meta http-equiv="Content-type" content="text/html;charset=UTF-8"><meta name="keywords" content="Wooepa"><meta name="description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:title"><link property="og:image" rel="image_wooepa" href="/img/logo_wooepa.png"><meta name="fragment" content="!"><link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"><meta property="og:description" content="Discover Events Near You - Invite your Friends - Get Rewarded !"><meta property="og:type" content="website"><meta property="og:url" content="http://wooepa.com"><meta property="og:image" content="http://wooepa.com/img/logo_wooepa.png"><meta property="og:site_name" content="Wooepa"><meta name="msvalidate.01" content="741DD559CC819DECAF2AA49D92578598"><meta name="google-site-verification" content="w79q3QuneD2E21myOjjIUeCobYxg7Rpv_TBQsZ_Yh2M"><link rel="stylesheet" href="/css/app.min.css"><link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu:300,400,500,400italic"><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script></head><body id="{{$state.current.name.replace(\'.\', \'-\')}}"><div class="container-fluid"><header headroom tolerance="0" offset="0" scroller=".app-view" classes="{pinned:\'pinned\',unpinned:\'unpinned\',initial:\'headroom\'}"><nav role="navigation" ng-controller="HeaderCtrl" class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><i ng-show="$state.current.name != \'list\'" style="float:left;color:white;margin-top:2%;" class="fa fa-chevron-left"></i><a href="/" ui-sref="list" ng-show="$state.current.name != \'list\'" style="margin:auto;" class="navbar-brand">Back</a><a href="/" ui-sref="list" ng-show="$state.current.name === \'list\'" class="navbar-brand">Wooepa</a><button type="button" ng-init="navCollapsed = true" ng-click="navCollapsed = !navCollapsed" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><i class="fa fa-bars"></i></button><a href="/" ui-sref="in_promotion" style="margin-left:10%;" class="navbar-brand">Events in Promotion</a><a href="/" ui-sref="events" ng-show="$root.user" style="margin-left:30%;margin-right:7%;" class="navbar-brand">My Events</a><ul class="nav navbar-nav navbar-right"><li ng-if="$root.user" ng-cloak class="dropdown"><a href="#" class="dropdown-toggle"><span class="avatar pull-right"><img src="{{ $root.user.facebook.picture }}" alt="{{ $root.user.facebook.name }}" class="img-circle"></span><span class="hidden-xs hidden-sm hidden-md">{{$root.user.facebook.name}}</span><i class="fa fa-chevron-down"></i></a><ul class="dropdown-menu"><li><a ui-sref="app.page.profile" href="/me/events">My events</a></li><li class="divider"></li><li><a href="/auth/signout" target="_self" translate>Logout<i class="fa fa-sign-out"></i></a></li></ul></li><li ng-if="!$root.user" ng-cloak><a ng-href="/auth/facebook?redirectUrl={{$root.location.path() | encodeUri}}?{{$root.stateParams | encodeUri}}" translate class="login">Login</a></li></ul></div></div></nav></header><div id="menu" ng-class="{\'in\':!navCollapsed}" class="navbar-collapse collapse"><ul class="nav navbar-nav visible-xs"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a href="#"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getTime() === Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getTime() !== Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><input type="date" ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date"></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></div><div class="banner"></div><div id="wrapper"><div ui-view class="container-fluid"></div></div><script type="text/javascript" src="/js/app.min.js"></script><script src="//localhost:35729/livereload.js"></script></div></body></html>');
  $templateCache.put('menu',
    '<div id="menu" ng-class="{\'in\':!navCollapsed}" class="navbar-collapse collapse"><ul class="nav navbar-nav visible-xs"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a href="#"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getTime() === Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getTime() !== Date.sun().getTime()"><a href="#"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><input type="date" ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date"></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></div>');
  $templateCache.put('event/in_promotion',
    '<section id="list"><h2 style="text-align:center;color:red;">Events in Promotion - Play and get Rewards !</h2><div class="events col-xs-12 col-sm-9 col-md-9 col-lg-10"><div ng-repeat="ev in events | orderBy:\'start_time\'" isotope ui-sref="list.view({slug: ev.slug, eid: ev.eid})" class="events-wrapper col-xs-12 col-sm-6 col-md-4 col-lg-3"><div class="event"><div class="top"><div class="background"></div><a href="{{\'http://localhost:3000/\' + ev.slug + \'/\' + ev.eid}}" class="title truncate">{{ev.name}}</a><div class="tag-list"><span ng-repeat="tag in ev.tags" ng-if="$index &lt; 3" ng-click="openTag($event, ev)" class="tag {{tag}}">{{tag}}</span></div></div><div class="image-container"><a href="{{\'http://localhost:3000/\' + ev.slug + \'/\' + ev.eid}}"><div class="image"><div ng-if="ev.price.num === 0" class="ribbon-wrapper-green"><div class="ribbon-green">{{ev.price.full}}</div></div><img ng-src="{{ev.pic_cover.source}}"></div></a></div><div class="bottom"><span class="datetime"><span class="date"><i class="fa fa-clock-o"></i><span>{{ev.start_time2 | amCalendar:\'D MMM\'}}</span></span></span><div ng-if="ev.attending_count &gt; 0" ev.attending_count="ev.attending_count" class="attending pull-right"><i class="fa fa-group"></i><span>{{ev.attending_count}}</span></div><div class="place-info"><div ng-click="openMap($event, ev)" ng-if="ev.location" class="span place"><i class="fa fa-map-marker"></i><span class="location">{{\' \' + ev.location | characters:20}}{{ev.location && ev.venue.city ? \', \' + ev.venue.city : \'\'}}</span></div></div></div><div class="box-shadow"></div></div></div></div></section>');
  $templateCache.put('event/list',
    '<section id="list" infinite-scroll="getMore()" infinite-scroll-distance="1" infinite-scroll-immediate-check="false" ng-show="$state.current.name === \'list\'">\n' +
    '<section id="sidebar" ng-controller="SidebarCtrl" class="hidden-xs col-sm-3 col-md-3 col-lg-2"><ul class="nav navbar-nav row"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"><span class="material-input"></span></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a ui-sref="list({since:getStringDate(today)})"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getDay() &gt;= 5 || today.getDat === 0"><a ui-sref="list({since:getStringDate(today)})"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getDay() &lt; 5 &amp;&amp; today.getDay &gt; 0"><a ui-sref="list({since:getNextDay(\'Friday\')})"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><datepicker ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date" show-weeks="false"></datepicker></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></section><div class="events col-xs-12 col-sm-9 col-md-9 col-lg-10"><div ng-repeat="ev in events track by ev.eid" id="{{$index}}" isotope ui-sref="list.view({slug: ev.slug, eid: ev.eid})" class="events-wrapper col-xs-12 col-sm-6 col-md-4 col-lg-3"><div class="event"><div class="top"><div class="background"></div><a ui-sref="list.view({slug: ev.slug, eid: ev.eid})" class="title truncate">{{ev.name}}</a><div class="tag-list"><span ng-repeat="tag in ev.tags" ng-if="$index &lt; 3" ng-click="openTag($event, ev)" class="tag {{tag}}">{{tag}}</span></div></div><div class="image-container"><div class="image"><div ng-if="ev.price.num === 0" class="ribbon-wrapper-green"><div class="ribbon-green">{{ev.price.full}}</div></div><img ng-src="{{ev.pic_cover.source}}"></div></div><div class="bottom"><span class="datetime"><span class="date"><i class="fa fa-clock-o"></i><span>{{ev.start_time2 | amCalendar:\'D MMM\'}} </span></span><!-- i.fa.fa-clock-o// span {{ev.start_time2 | amDateFormat:"LT"}}\n' +
    '--></span><div ng-if="ev.attending_count &gt; 0" ev.attending_count="ev.attending_count" class="attending pull-right"><i class="fa fa-group"></i><span>{{ev.attending_count}}</span></div><div class="place-info"><div ng-click="openMap($event, ev)" ng-if="ev.location" class="span place"><i class="fa fa-map-marker"></i><span class="location">{{\' \' + ev.location | characters:20}}{{ev.location && ev.venue.city ? \', \' + ev.venue.city : \'\'}}</span></div></div></div><div class="box-shadow"></div></div></div></div></section><ui-view></ui-view>');
  $templateCache.put('event/mobile-bar',
    '');
  $templateCache.put('event/promote',
    '<form class="event-form form-horizontal"><div class="modal-header">Event Promotion<div class="modal-body"><div class="control-group"><label class="control-label">Reward</label><span><input type="text" ng-model="ev.promotion.reward" placeholder="" class="medium-input"><label class="promote-label">Quantity</label><input type="text" ng-model="ev.promotion.quantity" placeholder="" class="small-input"><label class="promote-label">Value</label><input type="text" ng-model="ev.promotion.value" placeholder="" class="small-input"></span></div><div class="control-group date"><br><div ng-controller="DatepickerCtrl" class="form-group"><br><label for="title" class="col-md-2">Deadline</label><div class="col-md-10"><p class="input-group"><input ng-click="open($event)" datepicker-popup="{{format}}" style="width:50%" ng-model="ev.promotion.end_date" is-open="opened" datepicker-options="dateOptions" date-disabled="disabled(date, mode)" close-text="Close" class="small-input"><button ng-click="open($event)" class="btn btn-default"><i class="fa fa-calendar"></i></button></p></div></div><div ng-controller="TimepickerCtrl" class="form-group"><label style="margin-top:6%;" for="title" class="col-md-2 control-label">End Time</label><timepicker ng-model="ev.promotion.end_time" ng-change="changed()" hour-step="hstep" minute-step="mstep" show-meridian="ismeridian" required="false"></timepicker></div></div><div class="control-group"><label class="control-label">Commentary</label><textarea id="description" ng-model="ev.promotion.commentary" cols="30" rows="5" placeholder="Content" class="form-control"></textarea><input type="hidden" name="in_promotion" ng-model="ev.in_promotion" value="value"></div></div><div class="modal-footer"><button ng-click="submit()" class="btn btn-primary"><i class="fui-check"></i>OK</button><button ng-click="cancel()" class="btn btn-warning"><i class="fui-cross"></i>Cancel</button></div></div></form>');
  $templateCache.put('event/sidebar',
    '<section id="sidebar" ng-controller="SidebarCtrl" class="hidden-xs col-sm-3 col-md-3 col-lg-2"><ul class="nav navbar-nav row"><li class="search"><form class="navbar-form"><div class="form-control-wrapper"><i class="fa fa-search"></i><input type="text" placeholder="Type a city or location" typeahead="address.formatted_address for address in getLocation($viewValue)" typeahead-on-select="onSelect($item, $model, $label)" ng-model="locationSelected" ng-controller="LocationpickerCtrl" class="form-control col-lg-8"><span class="material-input"></span></div></form></li><li class="sort"><a href="#" ng-click="isCollapsed = !isCollapsed"><i class="fa fa-bar-chart-o"></i>Sort by<i ng-class="{\'fa-chevron-right\': isCollapsed, \'fa-chevron-down\': !isCollapsed}" class="pull-right fa"></i></a><ul collapse="isCollapsed" class="nav nav-collapse"><li><a href="#" ui-sref="list({sortBy: \'proximity\'})"><i class="fa fa-map-marker"> </i>Proximity</a></li><li><a href="#" ui-sref="list({sortBy: \'popularity\'})"><i class="fa fa-group"> </i>Popularity</a></li><li><a href="#" ui-sref="list({sortBy: \'\'})"><i class="fa fa-calendar"></i>Date</a></li></ul></li><li class="today"><a ui-sref="list({since:getStringDate(today)})"><i class="fa fa-calendar"></i>Today</a></li><li ng-if="today.getDay() &gt;= 5 || today.getDat === 0"><a ui-sref="list({since:getStringDate(today)})"><i class="fa fa-calendar"></i>This weekend</a></li><li ng-if="today.getDay() &lt; 5 &amp;&amp; today.getDay &gt; 0"><a ui-sref="list({since:getNextDay(\'Friday\')})"><i class="fa fa-calendar"></i>Next weekend</a></li><li class="datepicker"><datepicker ng-change="$state.go(\'list\', {since: getStringDate(date)})" ng-model="date" show-weeks="false"></datepicker></li><li class="tags">Explore by category<div class="tag-list"><a ng-repeat="tag in tags" ui-sref="list({tags: [tag]})" class="tag {{tag}}">{{tag}}</a></div></li></ul></section>');
  $templateCache.put('event/view',
    '<div id="view"><div class="container"><section class="header row"><div class="col-xs-12 col-sm-4 col-md-4 col-lg-4"><img src="{{ev.pic_cover.source}}"></div><div class="col-xs-12 col-sm-8 col-md-8 col-lg-8"><h3 class="title truncate">{{ev.name}}</h3><button ng-click="promote(ev)" ng-if="ev.creator.id === user.facebook.id || user.admin == true" class="btn btn-primary promote">Promote event</button><div class="tag-list"><span ng-repeat="tag in ev.tags" ng-if="$index &lt; 3" class="tag {{tag}}">{{tag}}</span></div><div class="title"><div class="attending"><i class="fa fa-group"></i>{{ev.attending_count}}</div><div class="price">{{ev.price.full}}</div></div><div class="datetime"><span class="time"><i class="fa fa-clock-o"></i><span>{{ev.start_time2 | amCalendar}}</span></span></div><div class="location"><a href="https://maps.google.com/maps?q={{ev.location + \' \' + ev.venue.street + \' \' + ev.venue.city + \' \' + ev.venue.country}}" target="_blank"><div ng-if="ev.location" class="place"><i class="fa fa-map-marker"></i>{{ev.location}} - {{ev.venue.street}}{{ev.venue.street && ev.venue.city ? \', \' : \'\'}}{{ev.venue.city}}{{ev.venue.city && ev.venue.country ? \', \' : \'\'}} {{ev.venue.country}}</div></a></div></div></section><section class="row"><div class="col-md-4"><div class="event-buttons wdiv padding-10"><div class="event-rsvp-btns"><button set-attendings class="btn btn-primary join">{{attending}}</button></div><div class="event-rsvp-btns"><button friend-selector class="btn btn-primary invite">Invite friends?</button></div><div class="event-rsvp-btns"><button share-event class="btn btn-primary share">Share?</button></div></div><div ng-hide="isInPromotion()" ng-if="ev.in_promotion" class="event-buttons wdiv padding-10"><div ng-repeat="player in ev.list_event_players | orderBy:\'-result\' | filter:search" ng-if="ng-if" class="alert alert-success"></div></div><div ng-if="ev.promotion" class="padding-10 promoter"><div class="panel panel-success"><div class="panel-heading">Game Active</div><div class="panel-body"><ul ng-if="ev.promoter" class="list-group"><li ng-if="ev.promoter" class="list-group-item"><img ng-src="{{ev.promoter.picture}}" ng-alt="{{ev.promoter.name}}" class="img-circle">{{ ev.promoter.name }}</li><li class="list-group-item">{{ev.promotion.reward}}</li><li class="list-group-item">End: &nbsp<strong>{{ev.promotion.end_date | amCalendar}}</strong></li></ul></div></div></div><div class="padding-10"><div class="panel panel-default"><div class="panel-heading">Players</div><div class="panel-body"><p list-event-player ng-hide="ev.list_event_players[0].uid">No Players yet !</p><ul class="list-group"><p ng-hide="!ev.list_event_players[0].uid">{{ev.list_event_players.length}} &nbsp Players !</p><input placeholder="Search player" type="text" ng-model="search.name" class="form-control input-sm"><hr><li ng-repeat="player in ev.list_event_players | orderBy:\'-result\'" class="list-group-item players"><table><tr><td><img ng-src="{{&quot;http://graph.facebook.com/&quot; + player.uid + &quot;/picture?type=square&quot;}}" ng-alt="{{player.name}}" class="img-circle"></td><td><table><tr><td>{{player.name}}</td></tr><tr><td>{{ player.result }} pts</td><td><button boost-player class="btn">Boost<i-fa-fa-flash></i-fa-fa-flash></button></td></tr></table></td></tr></table></li><li ng-repeat="player in ev.list_event_players | orderBy:\'-result\' | filter:search" ng-if="player.facebook.id != ev.player_id" class="list-group-item"><img ng-src="{{&quot;http://graph.facebook.com/&quot; + player.uid + &quot;/picture?type=square&quot;}}" ng-alt="{{player.name}}" class="img-circle">{{ player.result }} pts<button class="btn btn-primary">Boost</button><i-fa-fa-flash></i-fa-fa-flash></li></ul></div></div></div></div></section><section class="description row"><p ng-bind-html="ev.description | linky" class="description"></p></section><section class="location row"><a href="https://maps.google.com/maps?q={{ev.location + \' \' + ev.venue.street + \' \' + ev.venue.city + \' \' + ev.venue.country}}" target="_blank"><div style="background-image: url(https://maps.googleapis.com/maps/api/staticmap?center={{ev.venue.coord.lat + \',\' + ev.venue.coord.lng}}&amp;zoom=14&amp;size=640x200&amp;markers=color:blue|{{ev.venue.coord.lat + \',\' + ev.venue.coord.lng}})" class="map"></div></a></section><section class="media row"><ul ng-if="videos.length" class="youtube-videos"><li ng-repeat="video in videos" ng-if="$index &lt; 3" class="col-xs-6 col-sm-4 col-md-3 col-lg-4"><object type="text/html" data="{{video}}" class="img-thumbnail"></object></li></ul><ul ng-if="fbpics.length" class="facebook-pictures"><li ng-repeat="pic in fbpics" class="col-xs-12 col-sm-4 col-md-3 col-lg-4"><a ng-click="openLightboxModal(fbpics, $index)"><img ng-src="{{pic.thumbUrl}}" alt="" class="img-thumbnail"></a></li></ul><ul ng-if="instagramPhotos.length" class="instagram-photos"><li ng-repeat="photo in instagramPhotos" class="col-xs-12 col-sm-4 col-md-3 col-lg-4"><a ng-click="openLightboxModal(instagramPhotos, $index)"><img ng-src="{{photo.thumbUrl}}" alt="" class="img-thumbnail"></a></li></ul></section></div></div>');
  $templateCache.put('user/events',
    '<section id="list"><div style="text-align:center;"><h2 style="color:red;">Your Live Events !</h2><br><button ng-click="updateEvents()" style="background-color:red;color:white;" class="btn">Update</button></div><div class="events col-xs-12 col-sm-9 col-md-9 col-lg-10"><div ng-repeat="ev in events | orderBy:\'start_time\'" isotope ui-sref="list.view({slug: ev.slug, eid: ev.eid})" class="events-wrapper col-xs-12 col-sm-6 col-md-4 col-lg-3"><div class="event"><div class="top"><div class="background"></div><a href="{{\'http://localhost:3000/\' + ev.slug + \'/\' + ev.eid}}" class="title truncate">{{ev.name}}</a><div class="tag-list"><span ng-repeat="tag in ev.tags" ng-if="$index &lt; 3" ng-click="openTag($event, ev)" class="tag {{tag}}">{{tag}}</span></div></div><div class="image-container"><a href="{{\'http://localhost:3000/\' + ev.slug + \'/\' + ev.eid}}"><div class="image"><div ng-if="ev.price.num === 0" class="ribbon-wrapper-green"><div class="ribbon-green">{{ev.price.full}}</div></div><img ng-src="{{ev.pic_cover.source}}"></div></a></div><div class="bottom"><span class="datetime"><span class="date"><i class="fa fa-clock-o"></i><span>{{ev.start_time2 | amCalendar:\'D MMM\'}}</span></span></span><div ng-if="ev.attending_count &gt; 0" ev.attending_count="ev.attending_count" class="attending pull-right"><i class="fa fa-group"></i><span>{{ev.attending_count}}</span></div><div class="place-info"><div ng-click="openMap($event, ev)" ng-if="ev.location" class="span place"><i class="fa fa-map-marker"></i><span class="location">{{\' \' + ev.location | characters:20}}{{ev.location && ev.venue.city ? \', \' + ev.venue.city : \'\'}}</span></div></div></div><div class="box-shadow"></div></div></div></div></section>');
}]);

var app = angular.module('wooepa', ['wooepa-templates', 'geolocation', 'ngStorage', 'bootstrapLightbox', 'querystring', 'ui.router', 'ui.bootstrap', 'ezfb', 'truncate', 'rt.encodeuri', 'ngSanitize', 'angular-data.DSCacheFactory', 'angularMoment', 'gettext', 'infinite-scroll', 'headroom']); //'imageupload', , 'seo' 'leaflet-directive'
angular.module('infinite-scroll').value('THROTTLE_MILLISECONDS', 500);
var getStringDate = function(date) {
  var dd = date;
  var yy = dd.getYear();
  var mm = dd.getMonth() + 1;
  dd = dd.getDate();
  if (yy < 2000) {
    yy += 1900;
  }
  if (mm < 10) {
    mm = "0" + mm;
  }
  if (dd < 10) {
    dd = "0" + dd;
  }
  var rs = yy + "-" + mm + "-" + dd;
  return rs;
};
app.config(function($locationProvider, $urlRouterProvider, $stateProvider, ezfbProvider) {
  $locationProvider.html5Mode(true).hashPrefix('!');

  $stateProvider
  // .state('home', {
  //   url: '/',
  //   // url: '/',
  //   // controller: 'ListCtrl',
  //   // templateUrl: 'event/list',
  //   controller: function() {
  //     //   events: function($stateParams, Event) {
  //     //     console.log($stateParams);
  //     //     // $stateParams = _.compact($stateParams);

  //     //     return Event.findAll($stateParams);
  //   }
  //   // }
  // })
    .state('list', {
      // url: '{city}{slash:[/]?}{tag:[^0-9]}',
      // url: '/{city}',
      // url: '/{city}{slash:[/]?}{tag}',
      url: '/?since?lng?lat?country?tags?sortBy',
      templateUrl: 'event/list',
      controller: 'ListCtrl',
      resolve: {
        evs: function(Event, $stateParams) {
          return Event.get($stateParams);
        }
      }
    })
    .state('list.view', {
      url: ':slug/:eid',
      templateUrl: 'event/view',
      controller: 'ViewCtrl',
      parent: 'list',
      resolve: {
        ev: function(Event, $stateParams) {
          return Event.getOne($stateParams.eid);
        }
      }
    })
    .state('me', {
      parent: '',
      url: '/me/events',
      templateUrl: 'user/user'
    })
    .state('events', {
      url:'/my_events',
      controller: 'myEventsCtrl',
      templateUrl:'user/events'
    })
    .state('in_promotion', {
      url:'/in_promotion',
      controller: 'inPromotionCtrl',
      templateUrl:'event/in_promotion'
    })
    .state('me.logout', {
      parent: 'me',
      url: '/me/logout'
    });

  $urlRouterProvider.otherwise('/');

  ezfbProvider.setInitParams({
    appId: window.fbAppId,
    version: 'v2.2'
  });
});

app.config(function(datepickerPopupConfig) {
  // datepickerPopupConfig.appendToBody = true;
  datepickerPopupConfig.showButtonBar = false;
});

app.run(function($rootScope, $state, $stateParams, $location, $rootScope, $querystring, $localStorage, amMoment, ezfb, Geoip, Event) { //geolocation, reverseGeocode
  // geolocation.getLocation().then(function(data) {
  //   $rootScope.loc = {
  //     lat: data.coords.latitude,
  //     lng: data.coords.longitude
  //   };

  //   reverseGeocode.getAddress($rootScope.loc.lat, $rootScope.loc.lng, function(address) {
  //     $rootScope.address = address;
  //     console.log($rootScope.address);
  //   });
  // });

  $rootScope.$state = $state;
  $rootScope.$stateParams = $stateParams;

  $rootScope.location = $location;

  $rootScope.lang = navigator.language || navigator.userLanguage;

  amMoment.changeLocale($rootScope.lang);

  $rootScope.today = new Date();

  $rootScope.today.setSeconds(0);
  $rootScope.today.setMinutes(0);
  $rootScope.today.setHours(0);

  $rootScope.user = window.user;

  if (!$localStorage.lng || !$localStorage.lat) {
    Geoip.getLocation().success(function(data) {

      var loc = data.loc.split(',');
      loc = {
        lng: loc[1],
        lat: loc[0]
      };

      Event.query.lng = loc.lng;
      Event.query.lat = loc.lat;
      // delete res.data.loc;

      // $.address = res.data;

      $rootScope.city = data.region;

      $localStorage.lng = loc.lng;
      $localStorage.lat = loc.lat;
      $localStorage.city = $rootScope.city;



      // $localStorage.address = $rootScope.address;
      // $localStorage.city = $rootScope.city;
      // if ($state.current.name === 'home') {
      //   $state.transitionTo('list', {
      //     city: $rootScope.city
      //   });
      // }
    }).error(function(err) {
      console.log(err);
      Event.query.lng =  2.294694;
      Event.query.lat = 48.858093;
    });
  } else {
    // $rootScope.address = $localStorage.address;
    $rootScope.city = $localStorage.city;
    Event.query.lng = $localStorage.lng;
    Event.query.lat = $localStorage.lat;
    
    // if ($state.current.name === '') {
    // $state.transitionTo('list', {
    //   city: $rootScope.city
    // });
    // }
  }

  $rootScope.$on('$stateChangeStart', function(event, toState, toParams, fromState, fromParams) {

    $rootScope.stateParams = $querystring.toString(_.compactObject(toParams));

    if (toParams.slug === 'auth') {
      window.location.href = window.location.href;
    }

    // console.log(toState);
    // if (!toState.parent) {
    //   $rootScope.listRendered = true;
    // } else if (!$rootScope.listRendered) {
    //   // $rootScope.iso.layout();
    //   console.log($state.current);
    // // }
    // console.log(fromState);
    // console.log(toState);
    // if (fromState.name === '' && toState.name === 'list') {
    //   $rootScope.renderList = true;
    // } else if (fromState.parent === 'list' && toState.name === 'list') {
    //   $rootScope.renderList = true;
    // }

      // if (fromState.name === 'list.view' && toState.name === 'list') {
      //   event.preventDefault();
      // }
  });

  ezfb.init();
});
app.factory('Event', function($q, $http, DSCacheFactory, $rootScope, $querystring) {
  var cache = DSCacheFactory('eventCache');

  var query = {};

  return {
    query: query,
    getOne: function(eid) {
      var that = this;

      if (cache.get(eid)) {
        return cache.get(eid);
      }

      var deferred = $q.defer();

      $http.get('/api/events/' + eid).success(function(ev) {
        ev = that.normalize(ev);
        deferred.resolve(ev);
      });

      return deferred.promise;
    },
    get: function(params) {
      // console.log(query.since));
      query = {
        since: params.since || getStringDate($rootScope.today),
        country: params.country || query.country,
        lng: params.lng || query.lng,
        lat: params.lat || query.lat,
        tags: params.tags || query.tags,
        sortBy: params.sortBy || query.sortBy
      };

      // console.log(query);

      return this.runQuery();
    },
    getMore: function() {
      if (!query.skip) {
        query.skip = 30;
      } else {
        query.skip += 30;
      }

      return this.runQuery();
    },
    normalize: function(ev) {
      if (ev.attending_count >= 99) {
        ev.tags.push('popular');
      }

      if (ev.price) {
        if (ev.price.num === 0) {
          ev.tags.push('free');
        }
      }

      if (ev.festival) {
        ev.tags.push('festival');
      }

      ev.tags = _.uniq(ev.tags);

      ev.start_time = this.parseDate(ev.start_time, ev.timezone);
      ev.end_time = this.parseDate(ev.end_time, ev.timezone);
      ev.update_time = this.parseDate(ev.update_time, ev.timezone);

      return ev;
    },
    parseDate: function(date, tz) {
      if (!tz) {
        return date;
      }
      var parsed = moment(date).tz(tz).format("YYYY/MM/DD hh:mm A");
      return new Date(parsed);
    },
    runQuery: function() {
      var that = this;
      var deferred = $q.defer();

      $http.get('/api/events?' + $querystring.toString(_.compactObject(query))).success(function(evs) {
        var ev = {};

        for (var i = evs.length - 1; i >= 0; i--) {
          ev = evs[i];
          ev = that.normalize(ev);

          cache.put(ev.eid, ev);
        }

        deferred.resolve(evs);
      });

      return deferred.promise;
    }
  };
});
app.factory('fbphoto', function($http) {
  var base = 'https://graph.facebook.com';
  return {
    getFbPics: function(eid) {
      var request = '/' + eid + '/photos?acces_token=' + fbtok;
      var url = base + request;
      var config = {
        'params': {
          'event_id': eid,
          'access_token': fbtok,
          'callback': 'JSON_CALLBACK'
        }
      };
      return $http.jsonp(url, config);
    }
  };
});
var fbtok = 'CAAGPsrwaxr4BAB7D3ZBNlZAf7R5vPWZAu6xVZAD7gq1hdzMOVDsPq3Bsxl2AAojoGlDcQcEAzZAtmyDrOlrwDpOG7N64BTdloH0tDia3OPRb0fRLBXiLKATFMPzRoE0estUT8z6gz7Mb73yBLh3oXXFCt8UmI5fe3pLg0cUi1ZAamY02PZC25OxBYwMKYKMJKlzedF1CmIoh7Iekah5tJQ7';

app.factory('fbvideos', function($http) {
  var base = 'https://graph.facebook.com';

  return {
    getFbVideo: function(eid) {
      var request = '/' + eid + '/feed';
      var url = base + request;
      var config = {
        params: {
          event_id: eid,
          access_token: fbtok,
          filter: 'app_2392950137',
          callback: 'JSON_CALLBACK'
        }
      };
      return $http.jsonp(url, config);
    },
    getFbLink: function(feed, cb){
          if (feed && feed.data) {
      var i = 0;
      var url;
      var videos = [];
      while (feed.data[i]) {
        if (feed.data[i].type == "video") {
          url = feed.data[i].source;
          var j = 0;
          var youtube = url.indexOf("youtube");
          var facebook = url.indexOf("fbcdn-video");
          if (youtube != -1) {
            var test = 0;
            while (test != -1) {
              ++j;
              if (!url[j] || (url[j] == '/' && url[j + 1] == 'v' && url[j + 2] == '/'))
                test = -1;
            }
            j = j + 3;
            var videoId = "";
            var k = 0;
            while (url[j] && url[j] != '?') {
              videoId += url[j];
              ++j;
              ++k;
            }
            var new_url = "http://www.youtube.com/embed/" + videoId;
            j = 0;
            k = 0;
            videos.push(new_url)
          }
          else if (facebook != -1)
          {
            videos.push('http://www.facebook.com/video/embed?video_id=' + feed.data[i].object_id);
          }
        }
        ++i;
      }
        cb(videos);
    }
    }
  };
});
app.service('Geoip', function($http) {
  return {
    getLocation: function(lat, lng) {
      return $http.get('http://ipinfo.io/json');
    }
  };
});
var tokenInstagram = '1491272863.4fa115a.678e407407db496fa1db455f5d2f5eab';

app.factory('Instagram', function($http) {
  var base = "https://api.instagram.com/v1";

  return {
    getLocationId: function(lat, lng) {
      var request = '/locations/search';
      var url = base + request;
      var config = {
        'params': {
          'access_token': tokenInstagram,
          'lat': lat,
          'lng': lng,
          'callback': 'JSON_CALLBACK'
        }
      };
      return $http.jsonp(url, config);
    },
    getPhotosByLocationId: function(locationId, count) {
      var request = '/locations/' + locationId + '/media/recent';
      var url = base + request;
      var config = {
        'params': {
          'access_token': tokenInstagram,
          'count': count,
          'callback': 'JSON_CALLBACK'
        }
      };
      return $http.jsonp(url, config);
    }
  };
});
// app.service('reverseGeocode', function() {
//   var geocoder = new google.maps.Geocoder();

//   return {
//     getAddress: function(lat, lng, cb) {
//       var latlng = new google.maps.LatLng(lat, lng);

//       geocoder.geocode({
//         'latLng': latlng
//       }, function(results, status) {
//         if (status == google.maps.GeocoderStatus.OK) {
//           if (results[1]) {
//             cb(results[1]);
//           }
//         } else {
//           element.text('Geocoder failed due to: ' + status);
//         }
//       });
//     }
//   };
// });
// app.service('Slug', function() {
//   return {
//     slugify: function(str) {
//       str = str.replace(/^\s+|\s+$/g, ''); // trim
//       str = str.toLowerCase();

//       // remove accents, swap  for n, etc
//       var from = "/_,:;";
//       var to = "aaaaaeeeeeiiiiooooouuuunc------";
//       for (var i = 0, l = from.length; i < l; i++) {
//         str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
//       }

//       str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
//       .replace(/\s+/g, '-') // collapse whitespace and replace by -
//       .replace(/-+/g, '-'); // collapse dashes

//       return str;
//     }
//   };
// });
app.controller('DatepickerCtrl', function($scope) {
  $scope.open = function($event) {
    $event.preventDefault();
    $event.stopPropagation();

    $scope.opened = true;
  };

  $scope.minDate = new Date();

  $scope.date = $scope.minDate;

  $scope.dateOptions = {
    'year-format': "'yy'",
    'starting-day': 1,
    'show-weeks': false,
    'show-button-bar': false,
    'day-title-format': 'MMMM',
    'month-title-format': ''
  };

  $scope.format = 'dd - MMMM';
});
app.controller('EventPromoteCtrl', function($scope, $modalInstance, ev, $http) {
  $scope.ev = ev;
  $scope.ismeridian = true;
  $scope.cancel = function() {
    $modalInstance.dismiss('cancel');
  };
  $scope.submit = function()
  {
  if ($scope.ev.promotion.end_time)
  {
 	  var end_date = new Date($scope.ev.promotion.end_date).setHours($scope.ev.promotion.end_time.getHours(), $scope.ev.promotion.end_time.getMinutes());
  }
  	$http({
            method: 'POST',
            data: {
              eid: $scope.ev.eid,
              reward: $scope.ev.promotion.reward,
              commentary: $scope.ev.promotion.commentary,
              end_date: end_date,
              promoter: $scope.user.facebook.id,
              quantity: $scope.ev.promotion.quantity,
              value: $scope.ev.promotion.value,
            },
            url: '/api/promote_event/' + $scope.ev.eid
          }).success(function(){
              ev.in_promotion = true;
          });
  $modalInstance.dismiss('cancel');  
  };
});
app.controller('HeaderCtrl', function($scope, $location) {
	$scope.isCollapsed = true;

	$scope.changeDate = function(date) {
		date = getStringDate(date);
		$location.url('/date/' + date);
	};

	function getStringDate(aDate) {
		var dd = aDate;
		var yy = dd.getYear();
		var mm = dd.getMonth() + 1;
		dd = dd.getDate();
		if (yy < 2000) {
			yy += 1900;
		}
		if (mm < 10) {
			mm = "0" + mm;
		}
		if (dd < 10) {
			dd = "0" + dd;
		}
		var rs = yy + "-" + mm + "-" + dd;
		return rs;
	}
});
app.controller('inPromotionCtrl', function($scope, moment, $http) {
	$scope.getTags = function() {
    $scope.tags = _.uniq([].concat.apply([], _.pluck($scope.events, 'tags'))).sort();
  	};
	$http({url: '/api/my_events/in_promotion', method: 'GET'}).success(function(my_evs){
		$scope.events = my_evs;
		$scope.getTags();
	});
});

app.controller('ListCtrl', function($scope, $window, Event, evs) {
  $scope.events = evs;
  //$scope.mobileSortList = false;

  $scope.getTags = function() {
    $scope.tags = _.uniq([].concat.apply([], _.pluck($scope.events, 'tags'))).sort();
  };

  $scope.getTags();

  $scope.getMore = function() {
    if (!$scope.events || $scope.noMoreEvents) return;

    Event.getMore().then(function(evs) {
      if (evs.length) {
        $scope.events.push.apply($scope.events, evs);
        $scope.getTags();
      } else {
        $scope.noMoreEvents = true;
      }
    });
  };

  $scope.openMap = function($event, ev) {
    var location = ev.location + ' ' + ev.venue.street + ' ' + ev.venue.city + ' ' + ev.venue.country;
    $window.open('https://maps.google.com/maps?q=' + location);
    $event.stopPropagation();
  };

  $scope.openTag = function($event, ev) {

    $event.stopPropagation();
  };

});
app.controller('LocationpickerCtrl', function($scope, $state, $http, $rootScope) {
  $scope.locationSelected = $rootScope.city;

  $scope.onSelect = function($item, $model, $label) {
    var country;

    if ($item.address_components[0].types[0] === 'country') {
      country = $item.address_components[0].long_name.toLowerCase();
    }

    $state.go('list', {
      lng: $item.geometry.location.lng,
      lat: $item.geometry.location.lat,
      country: country
    });
  };

  $scope.getLocation = function(val) {
    return $http.get('http://maps.googleapis.com/maps/api/geocode/json', {
      params: {
        address: val,
        sensor: false,
        language: $rootScope.lang
      }
    }).then(function(response) {
      return response.data.results.map(function(location) {
        return location;
      });
    });
  };
});
app.controller('myEventsCtrl', function($scope, moment, $http) {
	$scope.getTags = function() {
    $scope.tags = _.uniq([].concat.apply([], _.pluck($scope.events, 'tags'))).sort();
  	};
  	$scope.updateEvents = function()
  	{
  		$http.get('/import/user/' + $scope.user.facebook.id).success(function(update_evs){
  			location.reload();
  		});
  	};
	$http({url: '/api/my_events/', method: 'GET'}).success(function(my_evs){
		$scope.events = my_evs;
		$scope.getTags();
	});
});
app.controller('SidebarCtrl', function($scope, Event, moment) {
  $scope.isCollapsed = true;

  // $scope.setQueryParam = function(date) {
  //   Events
  //   date = getStringDate(date);
  //   $location.url('/date/' + date);
  // };

  $scope.getStringDate = function(date) {
    var dd = date;
    var yy = dd.getYear();
    var mm = dd.getMonth() + 1;
    dd = dd.getDate();
    if (yy < 2000) {
      yy += 1900;
    }
    if (mm < 10) {
      mm = "0" + mm;
    }
    if (dd < 10) {
      dd = "0" + dd;
    }
    var rs = yy + "-" + mm + "-" + dd;
    return rs;
  };

  $scope.getNextDay = function(date) {
    var next;

    switch(date){
      case 'Sunday':
        next = moment().day(0);
        break;
      case 'Monday':
        next = moment().day(1);
        break;
      case 'Tuesday':
        next = moment().day(2);
        break;
      case 'Wednesday':
        next = moment().day(3);
        break;
      case 'Thursday':
        next = moment().day(4);
        break;
      case 'Friday':
        next = moment().day(5);
        break;
      case 'Saturday':
        next = moment().day(6);
        break;
    }
    next = new Date(next);
    var dd = next;
    var yy = dd.getYear();
    var mm = dd.getMonth() + 1;
    dd = dd.getDate();
    if (yy < 2000) {
      yy += 1900;
    }
    if (mm < 10) {
      mm = "0" + mm;
    }
    if (dd < 10) {
      dd = "0" + dd;
    }
    var rs = yy + "-" + mm + "-" + dd;
    return rs;
  };
});                                                                 
app.controller('TimepickerCtrl', function ($scope) {
  $scope.mytime = new Date();

  $scope.hstep = 1;
  $scope.mstep = 1;

  $scope.options = {
    hstep: [1, 2, 3],
    mstep: [1, 5, 10, 15, 25, 30]
  };

  $scope.ismeridian = true;
  $scope.toggleMode = function() {
    $scope.ismeridian = ! $scope.ismeridian;
  };

  $scope.update = function() {
    var d = new Date();
    d.setHours( 14 );
    d.setMinutes( 0 );
    $scope.mytime = d;
  };

  $scope.changed = function () {
    console.log('Time changed to: ' + $scope.mytime);
  };

  $scope.clear = function() {
    $scope.mytime = null;
  };
});
app.controller('ViewCtrl', function($scope, $rootScope, $state, ezfb, $modal, $http, Instagram, ev, fbphoto, fbvideos, Lightbox) {
  // console.log(ev);
  $scope.ev = ev;
  $scope.today = new Date();
  if ($rootScope.user) {
    $http.get('/api/rsvp/' + $scope.ev.eid + '/attendings').success(function(result) {
      $scope.ev.attending = result; 
      if ($scope.ev.attending.indexOf(parseInt($rootScope.user.facebook.id)) >= 0) 
      {
        $scope.attending = 'Leave';
        $http.post('/api/rsvp/' +$scope.ev.eid + '/rsvp');
      }
      else
        $scope.attending = 'Join';
  });
  }
  else if(!$rootScope.user){
      $scope.attending= 'Join';
  }
  fbvideos.getFbVideo($scope.ev.eid).success(function(feed) {
    if (feed){
      fbvideos.getFbLink(feed, function(res){
        if (res)
          $scope.videos = res;
      });
    }
  });

  fbphoto.getFbPics($scope.ev.eid).success(function(res) {
    var pics = res.data;
    $scope.fbpics = [];
    for (var i = pics.length - 1; i >= 0; i--) {
      var pic = pics[i];

      var image = {
        url: 'https://graph.facebook.com/' + pic.id + '/picture?width=9999&height=9999',
        thumbUrl: 'https://graph.facebook.com/' + pic.id + '/picture?width=350&height=350'
      };

      $scope.fbpics.push(image);
    }
  });

  Instagram.getLocationId($scope.ev.venue.coord.lat, $scope.ev.venue.coord.lng).success(function(res) {
    if (res.data.length > 0) {
      Instagram.getPhotosByLocationId(res.data[0].id, 10).success(function(res) {
        if (res.data.length > 0) {
          $scope.instagramPhotos = [];
          for (var i = res.data.length - 1; i >= 0; i--) {
            $scope.instagramPhotos[i] = {
              url: res.data[i].images.standard_resolution.url,
              thumbUrl: res.data[i].images.low_resolution.url
            };
          }
        }
      });
    }
  });
  $http.get('/api/resolve/' + $scope.ev.eid + '/results');

  $scope.openLightboxModal = function(pics, index) {
    console.log(pics, index)
    Lightbox.openModal(pics, index);
  };

  $scope.promote = function(ev) {
    var modalInstance = $modal.open({
      templateUrl: 'event/promote',
      controller: 'EventPromoteCtrl',
      resolve: {
        ev: function() {
          return ev;
        }
      }
    });

    modalInstance.result.then(function(selected) {
      $scope.ev = selected;
    }, function() {});
  };


  // $scope.attending = '';
  // $scope.today = new Date();

  // $scope.ev = event,

  //  $scope.attending = 'Join';
  // // $scope.shared = false;

  //  $scope.isDisabled = false;
  // // $scope.btnShareText = "Share with your friends?";
  // // $scope.btnShareClass = "btn btn-success";

  //  $scope.isBtnJoinDisabled = false;
  // // $scope.btnJoinText = "Join";

  //  $scope.isBtnLeaveDisabled = false;
  //  $scope.ev.promotion = {};
  //  $scope.ev.in_promotion = false;
  //$scope.btnLeaveText = "Leave";

  // $scope.boosted = 0;

  // $scope.ev.player_result = 0;

  // $scope.convertToUTC = function(date, timezone) {
  //   date = new Date(date);

  //   if (!timezone) {
  //     return date;
  //   }

  //   var transformed = moment(date.getTime()).tz(timezone).format("YYYY/MM/DD hh:mm A");
  //   transformed = new Date(transformed);

  //   return transformed;
  // };

  // $scope.isInPromotion = function() {
  //    var currentDate = new Date();

  //    if ($scope.ev) {
  //      if ($scope.ev.in_promotion) {

  //        var end_date = $scope.convertToUTC($scope.ev.promotion.end_time, "UTC");

  //        if (end_date >= currentDate) {
  //         return (true);
  //        }
  //     }
  //    }
  //    return (false);
  //  }

  // $scope.addBoost = function(player, event_id, btn) {
  //   $http.get('boost/' + event_id + '/' + player.facebook.id).post().success(function(res) {
  //     $scope.boosted = res.son_id;
  //     console.log(res);

  //     $http.get('boost/update/' + event_id + '/' + player.facebook.id).post().success(function(player_result) {
  //       $http.get('results/update/' + event_id + '/' + player.facebook.id).post().success(function(player_result) {
  //         player.result = player_result.result_boosted;
  //       });
  //     });
  //   });
  // }

  // $scope.supBoost = function(player_id, event_id) {
  //   $http.get('boost/' + event_id + '/' + player_id + "/sup").post().success(function(res) {
  //     $scope.boosted = 0;

  //     $http.get('results/' + player_id + '/' + event_id).get('result').success(function(player_res) {
  //       $http.get('results/un_update/' + event_id + '/' + player_id).post().success(function(player_result) {
  //         console.log(player_result);
  //       });
  //     });
  //   });
  // }

  // $scope.getBoost = function(event_id) {
  //   $http.get('boost/' + event_id).get('boost').success(function(res) {
  //     if (res) {
  //       $scope.boosted = res.son_id;
  //       return (res.son_id);
  //     } else
  //       return (0);
  //   });
  // }
  // if (!$scope.ev.list_event_players) {
  //   $scope.ev.list_event_players = [];
  // }

  //     Users.get('names').success(function(users) {
  // console.log (user);
  //     });

  // if (Global.user) {
  //   $scope.ev.player_id = Global.user.facebook.id;
  //   $scope.boosted = $scope.getBoost($scope.ev.eid);
  // }

  // if ($scope.ev.in_promotion) {
  //   console.log($scope.ev.creator.id);
  //   $http.get('user/' + $scope.ev.creator.id).get('').success(function(user) {
  //     $scope.ev.promoter = user;
  //     console.log(user);
  //   });
  // }

  // if (ev.list_event_players) {
  //   $http.get('users/' + ev.list_event_players.toString()).get('info').success(function(players) {
  //     if (players) {
  //       for (i = 0; i < players.length; i++) {
  //         players[i].result = 2;
  //       }
  //     }

  //     $scope.ev.list_event_players = players;
  //   });

  //   $http.get('resolve/' + ev.eid).get('results').success(function(results) {

  //     for (i = 0; i < $scope.ev.list_event_players.length; i++) {
  //       for (j = 0; j < results.length; j++) {
  //         if ($scope.ev.list_event_players[i] && $scope.ev.list_event_players[i].facebook.id == results[j].user_id)
  //           $scope.ev.list_event_players[i].result = results[j].result_boosted;
  //         if ($scope.ev.list_event_players[i].facebook.id == $scope.ev.player_id && $scope.ev.list_event_players[i].facebook.id == results[j].user_id) {
  //           $scope.ev.player_result = results[j].result_boosted;
  //           $scope.btnShareClass = "btn";
  //         }
  //       }
  //     }

  //     console.log($scope.ev.list_event_players)

  //     /*for (i = 0; i < ev.list_event_players.length; i++) {
  //         for (j = i; j < ev.list_event_players.length; j++) {
  //           if (results) {
  //             if (results[i] && results[j] && results[i].result < results[j].result)
  //             {
  //               var play = ev.list_event_players[i];
  //               ev.list_event_players[i] = ev.list_event_players[j];
  //               ev.list_event_players[j] = play;
  //             }
  //           }
  //         }
  //       }*/

  //   });
  // }
  // if (Global.authenticated) {
  //   $http.get('/api/rsvp/' + $scope.ev.eid + '/attendings').success(function(result) {
  //     $scope.ev.attending = result;

  //     if ($scope.ev.attending.indexOf(parseInt(window.user.facebook.id)) >= 0) {
  //       $scope.attending = 'Leave';
  //     } else {
  //       $scope.attending = 'Join';
  //     }
  //   });
  // }
  // var rsvp = Events.one(ev.eid);

  // Restangular.one('events', ev.eid)

  // $scope.setAttending = function(eid) {
  //   $scope.isBtnJoinDisabled = "true";
  //   $scope.btnJoinText = "...";

  //   $http.get('events/' + ev.eid + '/rsvp').post({
  //     attendingStatus: 'attending'
  //   }).success(function(res, err) {
  //     if (err) {
  //       console.log(err);
  //       $scope.isBtnJoinDisabled = false;
  //       $scope.btnJoinText = "Please log-in";
  //     } else {
  //       $scope.attending = 'attending';
  //       $scope.isBtnJoinDisabled = false;
  //       $scope.btnJoinText = "Join";
  //       $scope.ev.attending.push(Global.user.facebook.id);

  //       if (!$scope.ev.list_event_players)
  //         $scope.ev.list_event_players = [];


  //       var find = 0;

  //       for (i = 0; i < $scope.ev.list_event_players.length && find == 0; i++) {
  //         if ($scope.ev.list_event_players[i].facebook.id == Global.user.facebook.id)
  //           find = 1;
  //       }

  //       if (find) {
  //         console.log("Ok");
  //         for (i = 0; i < $scope.ev.list_event_players.length; i++) {
  //           if ($scope.ev.list_event_players[i].facebook.id == $scope.ev.player_id) {
  //             $scope.ev.list_event_players[i].result += 6;
  //             $scope.ev.player_result += 6;
  //             i = $scope.ev.list_event_players.length;
  //           }
  //         }
  //       } else {
  //         console.log("Test");
  //         if (Global.user) {
  //           if (!Global.user.result)
  //             Global.user.result = 2;
  //           for (i = 0; i < $scope.ev.attending.length; i++) {
  //             if ($scope.ev.attending[i] == Global.user.facebook.id)
  //               Global.user.result += 6;
  //           }
  //           console.log($scope.ev.list_event_players);

  //           $scope.ev.list_event_players.push(Global.user);
  //           $scope.ev.player_result = Global.user.result;
  //           $http.get('results/' + $scope.ev.eid).post().success(function(res) {});
  //         }
  //       }

  //     }
  //   });
  // }

  // $scope.setNotAttending = function(eid) {
  //   $scope.isBtnLeaveDisabled = "true";
  //   $scope.btnLeaveText = "...";

  //   $http.get('events/' + ev.eid + '/rsvp').post({
  //     attendingStatus: 'declined'
  //   }).success(function(res) {
  //     if ($scope.attending == "attending") {
  //       if (!$scope.ev.list_event_players)
  //         $scope.ev.list_event_players = [];
  //       else
  //         for (i = 0; i < $scope.ev.list_event_players.length; i++) {
  //           if ($scope.ev.list_event_players[i].facebook.id == $scope.ev.player_id) {
  //             $scope.ev.list_event_players[i].result -= 6;
  //             $scope.ev.player_result -= 6;
  //             i = $scope.ev.list_event_players.length;
  //           }
  //         }
  //     }

  //     $scope.attending = '';
  //     $scope.isBtnLeaveDisabled = false;
  //     $scope.btnLeaveText = "Leave";


  //     var index = -1;

  //     for (i = 0; i < $scope.ev.list_event_players.length && index == -1; i++) {
  //       if ($scope.ev.list_event_players[i].facebook.id == Global.user.facebook.id)
  //         index = i;
  //     }

  //     if (index != -1)
  //       $scope.ev.attending.splice(index, 1);
  //   });
  // }

  // $scope.sendInvitations = function(eid) {
  //   $http.get('invite/' + ev.eid + '/100004646590264').post().success(function(res) {});
  // }

  // $scope.shareEvent = function() {
  //   $scope.isDisabled = "true";
  //   $scope.btnShareText = "Sharing...";

  //   FB.ui(
  //       {
  //         method: 'share',
  //         href: link,
  //       },
  //       function(response) {
  //         if (response && !response.error_code) {
  //           $scope.shared = true;
  //           console.log("Shared");
  //         } else {
  //           $scope.isDisabled = "";
  //           $scope.btnShareText = "Share with your friends?";
  //         }
  //       }
  //     );

  //   $http.get('share/' + ev.eid).post().success(function(res) {
  //     console.log(res);
  //     if (res.error) {
  //       $scope.isDisabled = false;
  //       $scope.btnShareText = res.error;
  //     } else {
  //       $scope.isDisabled = false;
  //       $scope.btnShareText = "Share again?";
  //       $scope.btnShareClass = "btn";

  //       var find = 0;

  //       if (!$scope.ev.list_event_players)
  //         $scope.ev.list_event_players = [];

  //       for (i = 0; i < $scope.ev.list_event_players.length && find == 0; i++) {
  //         if ($scope.ev.list_event_players[i].facebook.id == Global.user.facebook.id)
  //           find = 1;
  //       }

  //       if (!find) {
  //         if (Global.user) {
  //           if (!Global.user.result)
  //             Global.user.result = 2;
  //           for (i = 0; i < $scope.ev.attending.length; i++) {
  //             if ($scope.ev.attending[i] == Global.user.facebook.id)
  //               Global.user.result += 6;
  //           }
  //           $scope.ev.list_event_players.push(Global.user);
  //           $scope.ev.player_result = Global.user.result;
  //         }
  //       }

  //     }
  //     $http.get('results/' + $scope.ev.eid).post().success(function(res) {});
  //   });
  // }
});
// app.directive('moDateInput', function($window) {
//     return {
//         require:'^ngModel',
//         restrict:'A',
//         link:function (scope, elm, attrs, ctrl) {
//             var moment = $window.moment;
//             var dateFormat = attrs.moMediumDate;
//             attrs.$observe('moDateInput', function (newValue) {
//                 if (dateFormat == newValue || !ctrl.$modelValue) return;
//                 dateFormat = newValue;
//                 ctrl.$modelValue = new Date(ctrl.$setViewValue);
//             });

//             ctrl.$formatters.unshift(function (modelValue) {
//                 if (!dateFormat || !modelValue) return "";
//                 var retVal = moment(modelValue).format(dateFormat);
//                 return retVal;
//             });

//             ctrl.$parsers.unshift(function (viewValue) {
//                 var date = moment(viewValue, dateFormat);
//                 return (date && date.isValid() && date.year() > 1950 ) ? date.toDate() : "";
//             });
//         }
//     };
// });

// app.directive("linkOverload", function () {
//     return function (scope, element) {
//         element.on("click", function (evt) {           
//             evt.preventDefault();
//         });
//     }
// });

// app.directive('backImg', function() {
//     return function(scope, element, attrs){
//         var url = attrs.backImg;
//         console.log(url);
//         element.css({
//             'background-image': 'url(' + url +')',
//             'background-size' : 'cover'
//         });
//     };
// });

app.directive('listEventPlayer', function($http, $rootScope) {
  return {
    restrict: 'A',
    link: function(scope, element, attrs) {
      $http({
        method: 'GET',
        data: {
          eid: scope.ev.eid
        },
        url: '/api/list_player/' + scope.ev.eid
      }).success(function(data) {
              scope.ev.list_event_players = data;
        });
    }
  };
});

app.directive('boostPlayer', function($http) {
  return {
    restrict: 'A',
    link: function(scope, elem, req) {
      $(elem).on("click", function() {
        $http.post('/api/boost/' + scope.ev.eid + '/' + scope.player.uid);
        $http.post('/api/boost/update/' + scope.ev.eid + '/' + scope.player.uid);
      });
      //$(elem).html(retour);
    }
  };
});

app.directive('isotope', function($rootScope) {
  return {
    restrict: 'A',
    link: function(scope, element, attrs) {
      imagesLoaded(element[0].parentElement, function(instance) {
        var iso = new Isotope(element[0].parentElement, {
          itemSelector: '.events-wrapper'
        });
      });
    }
  };
});

// app.directive('background', function($timeout) {
//   return {
//     restrict: 'A',
//     compile: function compile(tElement, tAttrs, transclude) {
//       return {
//         post: function postLink(scope, elm, iAttrs, controller) {
//             // console.log('child post')

//           $timeout(function(){
//             var image = $(elm).find('img:first')[0];

//             RGBaster.colors(image, {
//               success: function(payload) {
//                 // You now have the payload.
//                 console.log(payload.dominant);
//                 console.log(payload.secondary);
//                 console.log(payload.palette);

//                 elm.css('backgroundColor', payload.dominant);
//               }
//             });
//           }); 
//         },
//         pre:  function preLink(scope, iElement, iAttrs, controller) {
//           console.log('child pre');
//         }
//       };
//     }
//   };
// });

app.directive('shareEvent', function($http) {
  return {
    restrict: 'A',
    link: function(scope, element, req) {
      element.on("click", function() {
        $http({
          method: 'POST',
          data: {
            eid: scope.ev.eid
          },
          url: '/api/share/' + scope.ev.eid,
        }).success(function(){
            $http({
        method: 'GET',
        data: {
          eid: scope.ev.eid
        },
        url: '/api/list_player/' + scope.ev.eid
      }).success(function(data) {
        if (data)
        {
          var i = 0;
          scope.ev.list_event_players = data;
        }
          $("button.btn.btn-primary.share").html("Share again?");
          $("li.list-group-item.players").html("<li class='list-group-item players' ng-repeat='player in ev.list_event_players'></li>");
      });
      });
    });
  }
};
});

app.directive('friendSelector', function($http) {
  return {
    restrict: 'A',
    link: function(scope, elem, req) {
      $(elem).fSelector({
        onSubmit: function(uid) {
          // example response usage
          var event_intives = {
            method: 'events.invite',
            eid: scope.ev.eid,
            uids: uid,
            personal_message: 'custom request message'
          };
          $http({
            method: 'POST',
            data: {
              eid: scope.ev.eid,
              uids: uid
            },
            url: '/api/invite/' + scope.ev.eid + '/' + uid,
          }).success(function(data) {
      $http({
        method: 'GET',
        data: {
          eid: scope.ev.eid
        },
        url: '/api/list_player/' + scope.ev.eid
      }).success(function(data) {
        if (data)
        {
          var i = 0;
          scope.ev.list_event_players = data;
        }
          $("button.btn.btn-primary.invite").html("Invite again?");
          $("li.list-group-item.players").html("<li class='list-group-item players' ng-repeat='player in ev.list_event_players'></li>");
      });
          });
        }
      });
    }
  };
});

app.directive('setAttendings', function($http) {
  return {
    restrict: 'A',
    scope: true,
    link: function(scope, elem) {
      $(elem).on('click', function() {
        if (!scope.user || !scope.user.facebook || !scope.user.facebook.id)
        {
          document.location.href='/auth/facebook';
        }
        else if (scope.attending == 'Join') {
          $http.post('/api/rsvp/' + scope.ev.eid + '/rsvp').success(function(){
            $http({
        method: 'GET',
        data: {
          eid: scope.ev.eid
        },
        url: '/api/list_player/' + scope.ev.eid
      }).success(function(data) {
        if (data)
        {
          var i = 0;
          scope.ev.list_event_players = data;
        }
          $("li.list-group-item.players").html("<li class='list-group-item players' ng-repeat='player in ev.list_event_players'></li>");
          $("button.btn.btn-primary.join").html(scope.attending);
      });
          });
          scope.attending = 'Leave';
        } else if (scope.attending == 'Leave') {
          $http.post('/api/rsvpn/' + scope.ev.eid + '/rsvpn').success(function(){
            $http({
        method: 'GET',
        data: {
          eid: scope.ev.eid
        },
        url: '/api/list_player/' + scope.ev.eid
      }).success(function(data) {
        if (data)
        {
          var i = 0;
          scope.ev.list_event_players = data;
        }
          $("li.list-group-item.players").html("<li class='list-group-item players' ng-repeat='player in ev.list_event_players'></li>");
          $("button.btn.btn-primary.join").html(scope.attending);
      });
          });
          scope.attending = 'Join';
        } 
    });
  }
  };
});

app.directive('myTest', function(){
  return {
    restrict: 'A',
    scope: true,
    link: function(scope, elem){
  $(elem).countdown({until: scope.ev.promotion.end_date});
    }
  };
});
// app.directive("scroll", function() {
//  return function(scope, elm, attr) {
//      var raw = elm[0];
//      console.log(raw);
//      elm.bind('scroll', function() {
//          alert(1);
//          if (raw.scrollTop + raw.offsetHeight >= raw.scrollHeight) {
//              scope.$apply(attr.whenScrolled);
//          }
//      });
//  };
// });

angular.element(document).ready(function() {
  //Fixing facebook bug with redirect
  if (window.location.hash === '#_=_') window.location.hash = '#!';

  //Then init the app
  angular.bootstrap(document, ['wooepa']);

  (function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-48693864-1', 'wooepa.com');
  ga('send', 'pageview');

  // $('.dropdown-menu input, .dropdown-menu label').click(function(e) {
  //     e.stopPropagation();
  // });

  var $window = $(window);
  var scrollTime = 1.2;
  var scrollDistance = 300;

  $window.on("mousewheel DOMMouseScroll", function(event) {

    event.preventDefault();

    var delta = event.originalEvent.wheelDelta / 120 || -event.originalEvent.detail / 3;
    var scrollTop = $window.scrollTop();
    var finalScroll = scrollTop - parseInt(delta * scrollDistance);

    TweenMax.to($window, scrollTime, {
      scrollTo: {
        y: finalScroll,
        autoKill: true
      },
      ease: Power1.easeOut,
      overwrite: 5
    });

  });
});

_.mixin({
  compactObject: function(o) {
    _.each(o, function(v, k) {
      if (!v) {
        delete o[k];
      }
    });
    return o;
  }
});